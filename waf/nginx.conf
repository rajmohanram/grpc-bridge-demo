server {
    listen 443 ssl;
    server_name localhost;

    ssl_certificate /etc/ssl/certs/server.crt;
    ssl_certificate_key /etc/ssl/certs/server.key;
    ssl_trusted_certificate /etc/ssl/certs/ca.crt;

    # Enable SSL protocols - HTTP/1.1 only WAF
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    # WAF access logging to stdout
    access_log /dev/stdout combined;

    # Error logging to stderr for debugging
    error_log /dev/stderr info;

    # WAF that only handles HTTP/1.1 traffic
    location / {
        # Basic WAF security checks (simulated)
        # In production, add actual WAF rules here

        # Check for malicious patterns (example)
        if ($request_uri ~* "(union|select|insert|delete|drop|update|script)" ) {
            return 403;
        }

        # Allow gRPC-Web content types through WAF
        # gRPC-Web uses application/grpc-web and application/grpc-web+proto

        proxy_pass https://server-side-proxy:8443;
        proxy_http_version 1.1;

        # Preserve ALL original request headers (critical for gRPC-Web)
        proxy_pass_request_headers on;

        # Ensure gRPC-Web headers are preserved
        proxy_set_header Content-Type $http_content_type;
        proxy_set_header Accept $http_accept;
        proxy_set_header Grpc-Timeout $http_grpc_timeout;
        proxy_set_header Grpc-Encoding $http_grpc_encoding;
        proxy_set_header Grpc-Accept-Encoding $http_grpc_accept_encoding;

        # Override specific headers for WAF functionality
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WAF inspection headers (simulation)
        proxy_set_header X-WAF-Inspected "true";
        proxy_set_header X-WAF-Protocol "HTTP/1.1";
        proxy_set_header X-WAF-Timestamp $time_iso8601;

        # gRPC-optimized proxy settings
        proxy_buffering off;
        proxy_request_buffering off;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
        proxy_send_timeout 300s;

        # Handle gRPC streaming - clear connection header
        proxy_set_header Connection "";

        # Disable proxy redirects for gRPC
        proxy_redirect off;

        # Handle response headers properly for gRPC
        proxy_pass_request_body on;
        proxy_hide_header X-Powered-By;

        # Custom error pages for gRPC errors
        error_page 502 503 504 /grpc_error;
    }

    # Custom error handling for gRPC
    location = /grpc_error {
        internal;
        add_header Content-Type "application/grpc" always;
        add_header grpc-status "14" always;  # UNAVAILABLE
        add_header grpc-message "Service temporarily unavailable via WAF" always;
        add_header X-WAF-Error "true" always;
        return 200 "";
    }
}
